<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Tchat Node.js</title>

    <link rel="stylesheet" href="css/style.css">
</head>
<body>

    <main>
        <div class="messages">

        </div>

        <form class="tchatForm">
            <input type="text" id="message" placeholder="Votre message ...">
            <input type="submit">
        </form>
    </main>

    <aside class="usersList">
    </aside>

    <script src="/socket.io/socket.io.js"></script>
    <script>
    
        var pseudo = prompt('Entrez votre pseudo svp !');
        var list = []; // Par défaut, la liste connue de cet utilisateur est une liste vide

        var socket = io('ws://localhost:1337');
        
        // Envoi au serveur de mon pseudo
        socket.emit('setPseudo', pseudo);

        /* On écoutera ensuite du serveur chaque événement suivant :
            1) 'usersList' : Envoi de la liste initiale des utilisateurs connectés
            2) 'newUser' : Un nouvel utilisateur est arrivé sur le tchat
            3) 'userDisconnected' : Un utilisateur s'est déconnecté du tchat
            4) 'message' : Ecoute les nouveaux messages provenants du serveur
        */

        // 1)
        socket.on('usersList', function(usersList) {
            list = usersList; // Mise à jour de la liste de cet utilisateur
            buildList(list); // Reconstruction du <ul> au niveau du DOM
        });

        // 2)
        socket.on('newUser', function(newUser) {
            list.push(newUser); // Mise à jour de la liste de cet utilisateur
            buildList(list); // Reconstruction du <ul> au niveau du DOM
        });
        
        // 3)
        socket.on('userDisconnected', function(userQuit) {
            // Mise à jour de la liste de cet utilisateur
            list = list.filter(function(user) {
                return user.id !== userQuit.id;
            });
            buildList(list); // Reconstruction du <ul> au niveau du DOM
        });

        // Envoi des nouveaux messages dans le tchat
        document.getElementsByClassName('tchatForm')[0].onsubmit = function(e) {
            e.preventDefault();

            var text = document.getElementById('message').value;

            socket.emit('message', text);

            document.getElementsByClassName('messages')[0].innerHTML += '<p><strong>'+ pseudo +'</strong> '+ text +'</p>';
        };

        // 
        socket.on('message', function(message) {
            document.getElementsByClassName('messages')[0].innerHTML += '<p><strong>'+ message.pseudo +'</strong> '+ message.text +'</p>';
        });

        // -----------------------------

        // Cette fonction utilitaire prend en paramètre une liste d'utilisateurs, et met à jour le DOM avec
        function buildList(usersList) {
            var usersListElement = document.getElementsByClassName('usersList')[0];
            var content = '';
            
            usersList.forEach(function(user) {
                content += '<li>' + user.pseudo + '</li>';
            });
            
            usersListElement.innerHTML = content;
        }

    </script>

</body>
</html>